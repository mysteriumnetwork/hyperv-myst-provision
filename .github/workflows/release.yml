name: release

on:
  push:
    tags: ["*"]

jobs:
  release-windows-amd64:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17

      - name: Build
        run: |
          go build -v -trimpath -ldflags "-s -w" -o  bin/myst-vm-helper.exe github.com/mysteriumnetwork/hyperv-node/cmd/svc
          go build -v -trimpath -ldflags "-s -w" -o  bin/myst-vm-helper-vb.exe github.com/mysteriumnetwork/hyperv-node/cmd/svc2

        env:
          GOARCH: amd64
          GOOS: windows

      - name: Sign
        uses: mysteriumnetwork/code-sign-action@v7
        with:
          certificate: '${{ secrets.WINDOWS_CERTS }}'
          password: '${{ secrets.WINDOWS_CERTS_PASSWORD }}'
          certificatesha1: '${{ secrets.WINDOWS_CERTS_THUMBPRINT }}'
          certificatename: '${{ secrets.WINDOWS_CERTS_NAME }}'
          folder: 'bin'
          recursive: true

      - name: Upload
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            bin/myst-vm-helper.exe
            bin/myst-vm-helper-vb.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-amd64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16

    - name: Install QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y bridge-utils qemu-system-x86 qemu-utils ovmf expect cpu-checker zip virtualbox

    - name: Build image
      run: |
        wget -q https://dl-cdn.alpinelinux.org/alpine/v3.14/releases/x86_64/alpine-virt-3.14.3-x86_64.iso
        expect assets/alpine/provision-image-qemu.exp
        zip -q -9 alpine-vm-disk.zip alpine-vm-disk.vhdx
        zip -q -9 alpine-vm-disk-vdi.zip alpine-vm-disk.vdi

    - name: Upload
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          alpine-vm-disk.zip
          alpine-vm-disk-vdi.zip

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}